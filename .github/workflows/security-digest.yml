name: Security Daily Digest

on:
  schedule:
    # 日本時間 朝10時 (UTC 1:00) に実行
    - cron: '0 1 * * 1-5'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  notify:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # GitHub Appを使ってトークンを取得
      - name: Generate GitHub App Token
        id: generate_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      # Python 3.14 のセットアップ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.14' 

      # 標準ライブラリ(urllib)のみで動作するスクリプトを実行
      - name: Run Security Digest Script
        env:
          # リポジトリのSecretsに登録したSlack URL
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          # Stepで生成したApp Tokenを環境変数に渡す
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token }}
        run: |
          python .github/scripts/security_digest.py
